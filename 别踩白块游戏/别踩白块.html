<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>åˆ«è¸©ç™½å—</title>
		<style type="text/css">
			.wrap {
				width: 480px;
				margin: 0 auto;
				position: relative;
			}
			
			#mc {
				border: 1px solid black;
				background: white;
			}
			
			span {
				display: inline-block;
				margin: 10px 0;
				font-size: 18px;
			}
			
			#sp2 {
				color: red;
				margin-left: 20px;
			}
			
			#btn {
				float: right;
				width: 80px;
				height: 40px;
				background: skyblue;
				color: white;
				border-radius: 5px;
				font-size: 16px;
				margin-top: 5px;
				cursor: pointer;
			}
			
			.start {
				width: 485px;
				height: 805px;
				position: absolute;
				top: 0;
				left: 0;
			}
			
			img {
				width: 100%;
				height: 100%;
			}
			
			.text {
				text-align: center;
				color: white;
				font-size: 30px;
				position: absolute;
				top: 20%;
				left: 60px;
			}
			
			.end {
				width: 485px;
				height: 805px;
				position: absolute;
				top: 0;
				left: 0;
				text-align: center;
				background: rgb(253,62,54);
				display: none;
			}
			
			.text2 {
				margin-top: 40%;
				color: white;
				font-size: 30px;
			}
			
			.endtime {
				font-size: 70px;
				margin: 0;
				color: black;
				font-weight: bold;
			}
			
			.success {
				width: 485px;
				height: 805px;
				position: absolute;
				top: 0;
				left: 0;
				text-align: center;
				background: rgb(83, 214, 102);
				display: none;
			}
			
			.text3 {
				margin-top: 20%;
				color: white;
				font-size: 30px;
			}
			
			.endtime1 {
				font-size: 70px;
				margin: 0;
				color: black;
				font-weight: bold;
			}
			
			.again {
				font-size: 25px;
				cursor: pointer;
			}
			
			.best {
				color: red;
			}
			
			.jilu {
				color: yellow;
				font-size: 20px;
			}
		</style>
	</head>

	<body>
		<div class="wrap">
			<canvas id="mc" width="480" height="800"></canvas>
			<span id="sp1">åˆ†æ•°ï¼š0 åˆ†</span>
			<span id="sp2">æ—¶é—´ï¼š00:00 s</span>
			<button id="btn">å¼€å§‹æ¸¸æˆ</button>
			<div class="start">
				<img src="1.png" />
			</div>
			<div class="end">
				<div class="text2">
					<p>è¸©åˆ°ç™½å—å•¦ï¼ï¼ï¼</p>
					<h3>ç» å…¸ æ¨¡ å¼</h3>
					<p class="endtime"></p>
					<p class="endscore"></p>
					<span class="again">å†è¯•ä¸€æ¬¡</span>
				</div>
			</div>
			<div class="success">
				<div class="text3">
					<p>æ­å–œæ‚¨ï¼Œè¿‡å…³äº†ï¼ï¼ï¼</p>
					<h3>ç» å…¸ æ¨¡ å¼</h3>
					<p class="endtime1"></p>
					<p class="jilu"></p>
					<p class="endscore1"></p>
					<p class="best"></p>
					<span class="again">å†è¯•ä¸€æ¬¡</span>
				</div>
			</div>
			<div class="text">
				<h3>æ¸¸æˆè¯´æ˜</h3>
				<p>ä¸è¦è¸©åˆ°ç™½å—å“¦ ğŸ˜‡</p>
				<p>çœ‹çœ‹è°ç”¨æ—¶æœ€çŸ­,å¾—åˆ†æœ€é«˜ï¼ğŸ˜‡</p>
				<p>ç‚¹ä¸‹å³ä¸‹æ–¹å¼€å§‹æ¸¸æˆå§ï¼ğŸ˜‡</p>
			</div>
		</div>
	</body>
	<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
	<script type="text/javascript">
		var mc = document.getElementById('mc'); //ç”»å¸ƒ
		var ctx = mc.getContext('2d'); //ç”»ç¬”
		var score = 0;
		//å°è£…éšæœºæ•°å‡½æ•°
		function rn(x, y) {
			return Math.round(Math.random() * (y - x) + x)
		}
		//ç»˜åˆ¶æ¸¸æˆç•Œé¢
		function Draw() {
			this.bricksarr = []; //ç –å—æ•°ç»„
			this.rows = 4; //å››è¡Œ
			this.cols = 4; //å››åˆ—
			//ç –å—çš„å®½åº¦
			this.blockwidth = mc.width / 4;
			//ç –å—çš„é«˜åº¦
			this.blockheight = mc.height / 4;
			this.mouseclick();
		}
		//Drawçš„åŸå‹æ–¹æ³•
		Draw.prototype.block = function() {
			ctx.clearRect(0, 0, 480, 800);
			this.drawgrid(); //ç”»æ–¹æ ¼
			this.drawblack(); //ç”»ç –å—
		}
		//å¼€å§‹æ¸¸æˆ

		Draw.prototype.gamestart = function() {
			var me = this;
			me.numrows = 100; //æ€»çš„ç –å—æ•°
			me.startTime = new Date(); //è®°å½•æ¸¸æˆå¼€å§‹æ—¶é—´
			me.timer = setInterval(function() { //æ¯110mså¾ªç¯è°ƒç”¨å‡½æ•°ï¼ˆæ˜¾ç¤ºæ—¶é—´ï¼‰
				var showtime = new Date() - me.startTime; //ç°åœ¨æ—¶é—´å‡å»å¼€å§‹æ—¶é—´ç­‰äºæ˜¾ç¤ºæ—¶é—´
				$('#sp2').text('æ—¶é—´ï¼š' + showtime / 1000);
			}, 110)
			me.iniebrick();
			me.block();
		}
		//å¼€å§‹æ¸¸æˆæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
		$('#btn').click(function() {
			ctx.clearRect(0, 0, 480, 800);
			$('#btn').css('display', 'none');
			$('.start').css('display', 'none');
			$('.text').css('display', 'none');
			var kaishi = new Draw();
			kaishi.gamestart();
		});
		//å†è¯•ä¸€æ¬¡æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
		$('.again').click(function() {
			history.go(0);
			//				score = 0; //åˆå§‹åŒ–åˆ†æ•°
			//				$('#sp1').text('åˆ†æ•°ï¼š0 åˆ†');
			//				ctx.clearRect(0, 0, 480, 800);
			//				var kaishi = new Draw();
			//				kaishi.gamestart();
			//				$('.success').css('display', 'none');
			//				$('.end').css('display', 'none');

		});
		Draw.prototype.drawgrid = function() {
			//ç”»ç½‘æ ¼
			ctx.beginPath();
			for(var i = 1; i < this.cols; i++) { //åˆ—
				ctx.moveTo(i * this.blockwidth, 0);
				ctx.lineTo(i * this.blockwidth, mc.height);
			}
			for(var i = 1; i < this.rows; i++) { //è¡Œ
				ctx.moveTo(0, i * this.blockheight);
				ctx.lineTo(mc.width, i * this.blockheight);
			}
			ctx.stroke();
			ctx.closePath();
		}
		Draw.prototype.iniebrick = function() {
			//æ¯ä¸€è¡Œçš„ç –å—å‡ºç°åœ¨å“ªä¸€åˆ—çš„ä½ç½®æ˜¯éšæœºçš„
			for(var i = 0; i < this.rows; i++) {
				this.bricksarr[i] = rn(0, 3);
			}
		}
		Draw.prototype.drawblack = function() {
			//ç”»é»‘å—
			for(var i = 0; i < this.rows; i++) {
				var lie = this.bricksarr[i];
				if(lie != -1) {
					var x = lie * this.blockwidth;
					var y = i * this.blockheight;
					ctx.fillRect(x, y, this.blockwidth, this.blockheight);
				}
			}
		}
		Draw.prototype.bolckclick = function() {
			//æ¯ä¸ªé»‘å—çš„ç‚¹å‡»äº‹ä»¶
			var e = event || window.event;
			//offsetX è®¾ç½®æˆ–è·å–é¼ æ ‡æŒ‡é’ˆä½ç½®ç›¸å¯¹äºè§¦å‘äº‹ä»¶çš„å¯¹è±¡çš„ x åæ ‡ã€‚
			//offsetY è®¾ç½®æˆ–è·å–é¼ æ ‡æŒ‡é’ˆä½ç½®ç›¸å¯¹äºè§¦å‘äº‹ä»¶çš„å¯¹è±¡çš„ y åæ ‡ã€‚
			var x = Math.floor(e.offsetX / 120);
			var y = Math.floor(e.offsetY / 200);
			console.log(x,y);
			if(this.bricksarr[y] == x) {
				return {
					row: y,
					color: 'black'
				}
			} else return {
				row: y,
				color: 'white'
			};
		}

		Draw.prototype.mouseclick = function() { //é¼ æ ‡ç‚¹å‡»
			var me = this;
			//åœ¨canvasä¸Šç»‘å®šç›‘å¬äº‹ä»¶
			mc.addEventListener('click', function(e) {
				//å½“å‰æ—¶é—´å‡å»æœ‰æˆå¼€å§‹æ—¶é—´ç­‰äºæ˜¾ç¤ºæ—¶é—´
				var time1 = (new Date() - me.startTime) / 1000;
				var whereclick = me.bolckclick(e); //é¼ æ ‡æ­£åœ¨ç‚¹å‡»çš„ç –å—
				if(whereclick.color == 'white') { //è¸©åˆ°ç™½å—
					$('.end').css('display', 'block');
					$('#sp2').text('æ—¶é—´ï¼š' + time1 + 's'); //å°†ç»“æŸé¡µé¢çš„æ—¶é—´å†™å…¥æ˜¾ç¤ºæ—¶é—´é‡Œ
					$('.endtime').text(time1 + 's');
					$('.endscore').text('åˆ†æ•°ï¼š' + score + 'åˆ†');
					clearInterval(me.timer);
				} else if(whereclick.row == me.rows - 1) { //è¸©åˆ°æœ€åä¸€æ’é»‘è‰²ç –å—
					me.bricksarr.pop(); //ä»æ•°ç»„å°¾éƒ¨åˆ é™¤æœ€åä¸€æ’çš„ç –å—ä¿¡æ¯
					me.numrows--; //æ€»è¡Œæ•°å‡1
					score++;
					$('#sp1').text('åˆ†æ•°ï¼š' + score + 'åˆ†');
					if(me.numrows >= me.rows) {
						me.bricksarr.unshift(rn(0, 3)); //å¾€ç –å—æ•°ç»„å¤´éƒ¨æ·»åŠ 
					} else {
						me.bricksarr.unshift(-1); //-1è¡¨ç¤ºè¿™ä¸€æ’æ²¡æœ‰ç –å—
					}
					if(me.numrows == 0) {
						$('.success').css('display', 'block');
						$('#sp2').text('æ—¶é—´ï¼š' + time1 + 's'); //å°†ç»“æŸé¡µé¢çš„æ—¶é—´å†™å…¥æ˜¾ç¤ºæ—¶é—´é‡Œ
						$('.endtime1').text(time1 + 's');
						$('.endscore1').text('åˆ†æ•°ï¼š' + score + 'åˆ†');
						$('#btn').css('display', 'none');
						clearInterval(me.timer);
						//å®Œæˆnumrowsä¸ªç –å—æ‰€ç”¨çš„æœ€çŸ­æ—¶é—´æ›´æ–°åˆ°localStorageä¸­
						var besttime = localStorage.getItem('besttime');
						if(besttime == null) {
							localStorage.setItem('besttime', time1);
							$('.best').text('æœ€ä½³æˆç»©ï¼š' + time1 + 's');
						} else {
							if(besttime > time1) {
								$('.best').text('æœ€ä½³æˆç»©ï¼š' + time1 + 's');
								$('.jilu').text('æ–°çºªå½•è¯ç”Ÿå•¦ğŸ‰ğŸ‰ğŸ‰');
								localStorage.setItem('besttime', time1);
							} else {
								$('.best').text('æœ€ä½³æˆç»©ï¼š' + besttime + 's');
							}
						}
					}
					me.block();
				}
			})
		}
	</script>

</html>